<ion-header>
  <ion-toolbar color="light">
    <ion-title>Tareas del Proyecto</ion-title>
    <ion-buttons slot="end" *ngIf="!mostrarFormulario">
      <ion-button (click)="mostrarFormulario = true; tareaEditandoId = null; tareaForm.reset({ estado: 'pendiente' })">
        <ion-icon name="add-circle-outline" slot="start"></ion-icon>
        Añadir Tarea
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<!-- FORMULARIO -->
<ion-card *ngIf="mostrarFormulario">
  <ion-card-header>
    <ion-card-title>
      {{ tareaEditandoId ? 'Editar Tarea' : 'Nueva Tarea' }}
    </ion-card-title>
  </ion-card-header>
  <ion-card-content>
    <form [formGroup]="tareaForm" (ngSubmit)="crearTarea()">
      <ion-item>
        <ion-label position="stacked">Nombre</ion-label>
        <ion-input formControlName="nombre" required></ion-input>
      </ion-item>

      <ion-item>
        <ion-label position="stacked">Descripción</ion-label>
        <ion-textarea formControlName="descripcion"></ion-textarea>
      </ion-item>

      <ion-item>
        <ion-label position="stacked">Fecha inicio</ion-label>
        <ion-input type="date" formControlName="fecha_inicio" required></ion-input>
      </ion-item>

      <ion-item>
        <ion-label position="stacked">Fecha fin</ion-label>
        <ion-input type="date" formControlName="fecha_fin" required></ion-input>
      </ion-item>

      <ion-item>
        <ion-label position="stacked">Horas estimadas</ion-label>
        <ion-input type="number" formControlName="horas" min="1" required></ion-input>
      </ion-item>

      <!-- Estado como lista desplegable -->
      <ion-item>
        <ion-label position="stacked">Estado</ion-label>
        <ion-select formControlName="estado" placeholder="Seleccionar estado">
          <ion-select-option value="pendiente">Pendiente</ion-select-option>
          <ion-select-option value="en curso">En curso</ion-select-option>
          <ion-select-option value="finalizada">Finalizada</ion-select-option>
        </ion-select>
      </ion-item>

      <ion-item>
        <ion-label position="stacked">Asignar a usuario</ion-label>
        <ion-select formControlName="id_usuario" interface="popover" placeholder="Seleccionar usuario">
          <ion-select-option [value]="null">Sin asignar</ion-select-option>
          <ion-select-option *ngFor="let u of usuarios" [value]="u.id_usuario">
            {{ u.nombre }}
          </ion-select-option>
        </ion-select>
      </ion-item>

      <ion-button expand="block" type="submit" [disabled]="tareaForm.invalid">
        {{ tareaEditandoId ? 'Actualizar tarea' : 'Guardar tarea' }}
      </ion-button>
      <ion-button expand="block" fill="outline" color="medium" (click)="cancelarEdicion()">
        Cancelar
      </ion-button>
    </form>
  </ion-card-content>
</ion-card>

<!-- LISTA DE TAREAS -->
<ng-container *ngIf="!mostrarFormulario">
  <ion-card *ngFor="let tarea of tareas">
    <ion-card-header>
      <ion-card-subtitle [color]="tarea.estado === 'pendiente' ? 'warning' : (tarea.estado === 'en curso' ? 'tertiary' : 'success')">
        {{ tarea.estado | titlecase }}
      </ion-card-subtitle>
      <ion-card-title>{{ tarea.nombre }}</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <p><strong>Inicio:</strong> {{ tarea.fecha_inicio }}</p>
      <p><strong>Fin:</strong> {{ tarea.fecha_fin }}</p>
      <p><strong>Horas:</strong> {{ tarea.horas }}</p>
      <p><strong>Asignado a:</strong> {{ tarea.nombre_usuario || 'Sin asignar' }}</p>
      <ion-button fill="clear" size="small" color="primary" (click)="editarTarea(tarea)">
        <ion-icon name="create-outline" slot="icon-only"></ion-icon>
      </ion-button>
      <ion-button fill="clear" size="small" color="danger" (click)="eliminarTarea(tarea.id)">
        <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-card-content>
  </ion-card>
</ng-container>
